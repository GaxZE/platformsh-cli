name: Build the CLI
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

    - name: Determine composer cache directory
      id: composer-cache
      run: |
        echo "::set-output name=dir::$(composer config cache-files-dir)"

    - name: Restore composer cache
      uses: actions/cache@v1
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install dependencies
      run: composer install --no-progress --no-interaction --no-dev

    - name: Install Box
      run: |
          cd vendor-bin/box
          composer install --no-interaction --no-progress
          cd -
          mkdir -p vendor/bin
          ln -s "$(realpath vendor-bin/box/vendor/bin/box)" vendor/bin/box

    - name: Run self:build
      run: ./bin/platform self:build --no-composer-rebuild --yes --replace-version "$GITHUB_REF"-"$GITHUB_SHA" --output cli.phar

    - name: Upload Phar artifact
      uses: actions/upload-artifact@v1
      with:
        name: cli.phar
        path: cli.phar
